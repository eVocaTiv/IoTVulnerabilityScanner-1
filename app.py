from flask import Flask
from flask import Flask, flash, redirect, render_template, request, session, abort
from lib.models import Admin, DeviceOwner, Credentials, ProtocolScanner
import os

app = Flask(__name__)

@app.route("/")
def index():
    if not session.get('logged_in'):
        return render_template('login.html')
    else:
        print(myPort)
        verifyResult = protocolScanner.verifyCredentials( Credentials('a', 'b'))
        return render_template('dashboard.html' , res = verifyResult, addDeviceToggle = False)

@app.route('/login', methods=['POST','GET'])
def do_admin_login():
    if admin.verifyCredentials(Credentials(request.form['username'],request.form['password'])):
        session['logged_in'] = True
    else:
        flash('wrong password!')
    return index()

@app.route("/logout")
def logout():
    session['logged_in'] = False
    return index()

@app.route("/addDeviceToggle", methods = ['GET'])
def showAddDevice():
	return render_template('dashboard.html' , addDeviceToggle = True)

@app.route("/scanresults",  methods=['GET'])
def display_scan_results():
	return render_template('scanresults.html')
	# will also pass the scan results object into this template.
@app.route("/notifyuser", methods=['POST'])
def notifyUser():
	# call notify user from service layer.
	#implement client side error handling.
	flash('Device Owner Notified!...')
	return render_template('dashboard.html', addDeviceToggle = False)
@app.route("/addNewDevice", methods=['POST'])
def addNewDevice():
	#handle exceptions and return appropriate message
    #call add new device method of service layer.
    #
    return "Device Added" +  "<br><br> <a href='/'> Go back </a>"

if __name__ == "__main__":
    admin = Admin("admin name","admin email",Credentials("admin","password"))
    protocolScanner = ProtocolScanner("Kunal Protocol" , "9997", "Kunal Host" )
    myPort = protocolScanner.getPortNumber()
    app.secret_key = os.urandom(12)
    app.run(debug=True,host='127.0.0.1', port=4000)
