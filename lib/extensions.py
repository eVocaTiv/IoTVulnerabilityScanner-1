from sqlalchemy import *
import random 
from random import randrange, getrandbits
import time
from ipaddress import IPv4Address

def createTables():
	db = create_engine('sqlite:///iot.db')

	db.echo = True  # True means verbose log

	metadata = MetaData(db)

	cred = Table('Credentials', metadata,
	    Column('username', String, primary_key=True),
	    Column('password', String,primary_key = True)
	)
	cred.create()

	scanResults = Table('ScanResults',metadata,
		Column('Timestamp', String, primary_key = True),
		Column('Vulnerable', String),
		Column('IPAddress', String, primary_key = True),
		Column('Device', String),
		Column('portNumber', Integer, primary_key = True),
		Column('protocolName', String),
		Column('os', String),
		Column('arch', String)
		)
		
	scanResults.create()
	return None

def createAdminDB():

	db = create_engine('sqlite:///iot.db')

	db.echo = True  # True means verbose log

	metadata = MetaData(db)

	users = Table('AdminCredentials',metadata,
		Column('username',String,primary_key = True),
		Column('password',String,primary_key = True),
		Column('emailID',String)
		)
	users.create()
	return None


def populateScanResultsDB():
	db = create_engine('sqlite:///iot.db')

	db.echo = True  # True means verbose log

	metadata = MetaData(db)

	scanResults = Table('ScanResults',metadata, autoload= True)

	ins = scanResults.insert()

	vul = ['Yes','No','No','No']
	dev = ['Raspi','NodeMCU']
	protocol = ['SSH','FTP','telnet','HTTP_GET']
	os_ = ['Linux','RTOS']
	arch_ = ['x64','x86_64']

	for i in range(1000):
		vulnerable = random.choice(vul)
		device = random.choice(dev)
		mapped = zip(dev, os_) 
		mapped = list(mapped) 
		mapp = random.choice(mapped)
		device = mapp[0]
		_os = mapp[1]
		_arch = random.choice(arch_)
		portN = randrange(1024)
		times = randomize_time()
		ip_address = IP_generator()
		prot = random.choice(protocol)
		
		ins.execute(Timestamp = times, Vulnerable = vulnerable, IPAddress = ip_address, Device = device, portNumber = portN, protocolName = prot, os = _os, arch = _arch)

def randomize_time():
	start_timestamp = time.mktime(time.strptime('Sept 1 2018  01:33:00', '%b %d %Y %I:%M:%S'))
	end_timestamp = time.mktime(time.strptime('Dec 1 2018  12:33:00', '%b %d %Y %I:%M:%S'))
	return time.strftime('%b %d %Y %I:%M:%S', time.localtime(randrange(start_timestamp,end_timestamp)))

def IP_generator():
	bits = 1260000 + getrandbits(32)%128 # generates an integer with 32 random bits
	addr = IPv4Address(bits) # instances an IPv4Address object from those bits
	addr_str = str(addr)
	return addr_str

createAdminDB()

